\section{Authentifizierung und Autorisierung}
Daten zu Schulen -und Lerngruppen (Klassen und Kurse) können durch einen automatischen Sync aus dem IDM im Zielsystem initial angelegt bzw. aktualisiert werden. 
Dazu kann ein technisches Benutzerkonto mit der Rolle \"sync-system\" genutzt werden (s. Kapitel \ref{Benutzerrollen} \nameref{Benutzerrollen}).
Wie unter Kapitel \ref{Benutzerrollen} \nameref{Benutzerrollen} zu sehen, enthalten die Datenmodelle zu Schulen und Lerngruppen keine personenbezogen Daten, sondern nur die IDs (uuid) aus dem IDM. \\
\\
Um im Zielsystem auch für den Login keine Anmeldeinformationen vorhalten zu müssen, wird eine Authentifizierung und Autorisierung per OAuth2-Protokoll und OpenID Connect empfohlen.\\
\\
Der Ablauf der Autorisierung per OAuth2-Protokoll im Authorization-Code-Flow ist in der folgenden Grafik dargestellt. 
\\
to be inserted\\
\\
Über den Access Token erhält das Zielsystem schließlich Zugriff auf die ID (uuid) des Users in Form des ID Tokens. 
Sofern die personenbezogenen Daten für die Anlage eines Benutzerkontos (z.B. Vor- und Nachname, E-Mail-Adresse) benötigt werden, können diese durch die geeignete Wahl von scopes und claims im Aufruf der Autorisierungs-URL vom Resource Server abgefragt werden und initial zur Benutzerkontoerstellung genutzt werden.\\
\\
Der IDM-Provider muss dabei den Autorisierungsserver (OpenID Provider) und Resource Server zur Verfügung stellen, zudem müssen folgende Endpunkte definiert sein:\\
\\
\begin{table}[htb]
    \begin{tabularx}{\textwidth}{|c|X|}
        \hline
\textbf{Endpunkt} & \textbf{Funktion des Endpunkts} \\ \hline
Autorisierung & Initiierung der Autorisierung und User-Zustimmung mit definierten Parametern (u.a. scopes/claims und Redirect-URL) \\ \hline
Token & Liefert ID und Access Token zurück \\ \hline
UserInfo & Liefert die angefragten Benutzerdaten zurück (z.B. uuid, Vor- und Nachname, E-Mail-Adresse) \\ \hline
    \end{tabularx}

        \caption{Endpunkte, die durch den IDM-Provider für die Anmeldung per OAuth2 in Verbindung mit OpenID Connect zur Verfügung gestellt werden müssen}
        \label{tab:auth:endpoints}
\end{table}
\\
\\
Die ID des Benutzers genügt nun, um per REST-API (s. Endpunkt /api/user/\$id) die weiteren Informationen des Benutzer aus dem IDM zu abzufragen. 
Das an diesem Endpunkt gelieferte Datenobjekt liefert auch die Rollen-Institutions-Kombinationen des Benutzers. 
Ein Benutzer kann mehrere Institution-Rolle-Kombinationen haben. 
So kann er zum Beispiel an verschiedenen Institutionen als Lehrkraft tätig oder an derselben Institution sowohl Lehrkraft als auch Elternteil eines Schülers sein. 
In der Zielanwendung können diese Kombinationen zusammengefasst werden und die Rechte ggf. additiv verwenden. 
Alternativ trennt man die Institution-Rolle-Kombination und lässt den Benutzer diejenige Kombination wählen, mit der der Benutzer interagieren möchte. 
Eine Speicherung der zuletzt gewählten Kombination im Zielsystem ist dabei möglich.
